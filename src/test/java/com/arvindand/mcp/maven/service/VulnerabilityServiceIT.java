package com.arvindand.mcp.maven.service;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;

import com.arvindand.mcp.maven.model.MavenCoordinate;
import com.arvindand.mcp.maven.model.security.SecurityAssessment;
import java.util.List;
import java.util.Map;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

/**
 * Integration tests for VulnerabilityService against OSV.dev API.
 *
 * @author Arvind Menon
 * @since 2.0.0
 */
@SpringBootTest
@ActiveProfiles("test")
class VulnerabilityServiceIT {

  @Autowired private VulnerabilityService vulnerabilityService;

  @Test
  void testScanDependency() {
    // Test that we can successfully query OSV for any dependency
    MavenCoordinate coord = MavenCoordinate.of("org.springframework", "spring-core", "6.2.0");

    SecurityAssessment result = vulnerabilityService.scan(coord);

    assertNotNull(result, "Should return a result");
    // We only verify the API call succeeded - don't assume specific vulnerability status
    // as this can change over time when new CVEs are discovered
    assertNotEquals(
        SecurityAssessment.Status.UNKNOWN,
        result.status(),
        "Should successfully query OSV (not UNKNOWN status)");
    System.out.println("Spring Core 6.2.0 security status: " + result.status());
    System.out.println("Vulnerabilities found: " + result.vulnerabilityCount());
  }

  @Test
  void testScanHistoricallyVulnerableDependency() {
    // Log4j 2.14.1 has the famous Log4Shell vulnerability (CVE-2021-44228)
    // This is a historical vulnerability that will never be "fixed" for this version
    MavenCoordinate coord = MavenCoordinate.of("org.apache.logging.log4j", "log4j-core", "2.14.1");

    SecurityAssessment result = vulnerabilityService.scan(coord);

    assertNotNull(result, "Should return a result");
    // Verify OSV API responded successfully
    assertNotEquals(
        SecurityAssessment.Status.UNKNOWN,
        result.status(),
        "Should successfully query OSV (not UNKNOWN status)");

    System.out.println("Log4j 2.14.1 security status: " + result.status());
    System.out.println("Vulnerabilities found: " + result.vulnerabilityCount());

    // Log4j 2.14.1 will always be vulnerable - Log4Shell is a historical fact
    // that cannot change for this specific version
    assertEquals(
        SecurityAssessment.Status.VULNERABLE,
        result.status(),
        "Log4j 2.14.1 should be marked as VULNERABLE (Log4Shell CVE-2021-44228)");
  }

  @Test
  void testScanWithoutVersion() {
    // Should return UNKNOWN when version is missing
    MavenCoordinate coord = MavenCoordinate.of("org.springframework", "spring-core");

    SecurityAssessment result = vulnerabilityService.scan(coord);

    assertNotNull(result);
    assertEquals(SecurityAssessment.Status.UNKNOWN, result.status());
  }

  @Test
  void testBulkScan() {
    List<MavenCoordinate> coords =
        List.of(
            MavenCoordinate.of("org.springframework", "spring-core", "6.2.0"),
            MavenCoordinate.of("org.apache.logging.log4j", "log4j-core", "2.14.1"),
            MavenCoordinate.of("com.fasterxml.jackson.core", "jackson-databind", "2.17.0"));

    Map<String, SecurityAssessment> results = vulnerabilityService.scanBulk(coords);

    assertNotNull(results);
    assertEquals(3, results.size(), "Should return results for all 3 dependencies");

    for (var entry : results.entrySet()) {
      System.out.println(entry.getKey() + " -> " + entry.getValue().status());
      assertNotNull(entry.getValue(), "Each result should be non-null");
    }
  }
}
