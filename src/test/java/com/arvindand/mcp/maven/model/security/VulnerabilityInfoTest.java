package com.arvindand.mcp.maven.model.security;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.stream.Stream;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

/**
 * Unit tests for VulnerabilityInfo.
 *
 * @author Arvind Menon
 * @since 2.0.0
 */
class VulnerabilityInfoTest {

  @ParameterizedTest
  @MethodSource("cvssToSeverityTestData")
  void fromCvss_MapsScoreToCorrectSeverity(double cvss, VulnerabilityInfo.Severity expected) {
    VulnerabilityInfo.Severity result = VulnerabilityInfo.Severity.fromCvss(cvss);

    assertThat(result).isEqualTo(expected);
  }

  @SuppressWarnings("unused")
  private static Stream<Arguments> cvssToSeverityTestData() {
    return Stream.of(
        // Critical (9.0-10.0)
        Arguments.of(10.0, VulnerabilityInfo.Severity.CRITICAL),
        Arguments.of(9.5, VulnerabilityInfo.Severity.CRITICAL),
        Arguments.of(9.0, VulnerabilityInfo.Severity.CRITICAL),
        // High (7.0-8.9)
        Arguments.of(8.9, VulnerabilityInfo.Severity.HIGH),
        Arguments.of(8.0, VulnerabilityInfo.Severity.HIGH),
        Arguments.of(7.0, VulnerabilityInfo.Severity.HIGH),
        // Medium (4.0-6.9)
        Arguments.of(6.9, VulnerabilityInfo.Severity.MEDIUM),
        Arguments.of(5.0, VulnerabilityInfo.Severity.MEDIUM),
        Arguments.of(4.0, VulnerabilityInfo.Severity.MEDIUM),
        // Low (0.1-3.9)
        Arguments.of(3.9, VulnerabilityInfo.Severity.LOW),
        Arguments.of(2.0, VulnerabilityInfo.Severity.LOW),
        Arguments.of(0.1, VulnerabilityInfo.Severity.LOW),
        // Unknown (0.0 or negative)
        Arguments.of(0.0, VulnerabilityInfo.Severity.UNKNOWN),
        Arguments.of(-1.0, VulnerabilityInfo.Severity.UNKNOWN));
  }

  @Test
  void isCriticalOrHigh_WithCritical_ReturnsTrue() {
    VulnerabilityInfo vuln =
        new VulnerabilityInfo(
            "CVE-2021-44228", VulnerabilityInfo.Severity.CRITICAL, 10.0, "Test", null, null);

    assertThat(vuln.isCriticalOrHigh()).isTrue();
  }

  @Test
  void isCriticalOrHigh_WithHigh_ReturnsTrue() {
    VulnerabilityInfo vuln =
        new VulnerabilityInfo("CVE-TEST", VulnerabilityInfo.Severity.HIGH, 7.5, "Test", null, null);

    assertThat(vuln.isCriticalOrHigh()).isTrue();
  }

  @Test
  void isCriticalOrHigh_WithMedium_ReturnsFalse() {
    VulnerabilityInfo vuln =
        new VulnerabilityInfo(
            "CVE-TEST", VulnerabilityInfo.Severity.MEDIUM, 5.0, "Test", null, null);

    assertThat(vuln.isCriticalOrHigh()).isFalse();
  }

  @Test
  void isCriticalOrHigh_WithLow_ReturnsFalse() {
    VulnerabilityInfo vuln =
        new VulnerabilityInfo("CVE-TEST", VulnerabilityInfo.Severity.LOW, 2.0, "Test", null, null);

    assertThat(vuln.isCriticalOrHigh()).isFalse();
  }

  @Test
  void recordFields_AreAccessible() {
    VulnerabilityInfo vuln =
        new VulnerabilityInfo(
            "CVE-2021-44228",
            VulnerabilityInfo.Severity.CRITICAL,
            10.0,
            "Log4Shell vulnerability",
            "2.17.0",
            "https://nvd.nist.gov/vuln/detail/CVE-2021-44228");

    assertThat(vuln.id()).isEqualTo("CVE-2021-44228");
    assertThat(vuln.severity()).isEqualTo(VulnerabilityInfo.Severity.CRITICAL);
    assertThat(vuln.cvssScore()).isEqualTo(10.0);
    assertThat(vuln.summary()).isEqualTo("Log4Shell vulnerability");
    assertThat(vuln.fixedVersion()).isEqualTo("2.17.0");
    assertThat(vuln.reference()).isEqualTo("https://nvd.nist.gov/vuln/detail/CVE-2021-44228");
  }

  @Test
  void severityWeight_ReturnsCorrectValues() {
    assertThat(VulnerabilityInfo.Severity.CRITICAL.weight()).isEqualTo(4);
    assertThat(VulnerabilityInfo.Severity.HIGH.weight()).isEqualTo(3);
    assertThat(VulnerabilityInfo.Severity.MEDIUM.weight()).isEqualTo(2);
    assertThat(VulnerabilityInfo.Severity.LOW.weight()).isEqualTo(1);
    assertThat(VulnerabilityInfo.Severity.UNKNOWN.weight()).isZero();
  }
}
